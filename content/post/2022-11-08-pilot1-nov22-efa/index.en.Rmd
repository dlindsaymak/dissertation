---
title: 'DEEP CTN EFA (Pilot 1 Prolific Nov22)'
author: Deb Lindsay
date: "`r Sys.Date()`"
slug: efa_nov22
categories:
  - EFA
tags: []
subtitle: ''
summary: ''
authors: []
lastmod: "`r Sys.Date()`"
featured: no
image:
  caption: ''
  focal_point: ''
  preview_only: no
projects: []
output:
  blogdown::html_page:
    toc: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(collapse = TRUE)
```

```{r Packages and Functions required, include=FALSE}

library(tidyverse) #base package that runs most functions
library(Hmisc) #correlations
library(corrplot) #correlations
library(DataExplorer) #Data exploration
library(SmartEDA) #Data exploration
library(ggpubr) #Data exploration
# library(dlookr) #Data exploration (not available in this version)
library(flextable) #tables
library(corpcor) #Factor analysis
library(GPArotation) #Factor analysis
library(psych) #Factor analysis
library(lavaan)#Factor analysis
```

```{r loading data, include=FALSE}
pilot_prolific <-
  read_csv("pilot1_data_clean.csv")

items <-
  read_csv("item names.csv")



```

This is the first pilot study testing the factor structure of the new
CTN scale. Pilot data was collected using Prolific on November 8, 2022.

# Sample Descriptives {.tabset}

```{r Demographics, echo=FALSE}
pilot_prolific<-
  pilot_prolific %>% 
  mutate(age = as.numeric(age))

pilot_prolific$gender <- 
  factor(pilot_prolific$gender, levels = c("man", "woman", "trans man", "trans woman", "non-binary", "other", "no_answer"))

prolific_demos <-
pilot_prolific %>% 
  ExpCustomStat(Cvar = "gender", Nvar = "age", stat = c("mean", "count"), gpby = TRUE)

n_prolific <- length(pilot_prolific$id)
m_age_prolific <-round(mean(pilot_prolific$age),2)
sd_age_prolific <-round(sd(pilot_prolific$age),2)
min_age <- min(pilot_prolific$age)
max_age <- max(pilot_prolific$age)

m_pol <- paste(round(mean(pilot_prolific$politics_1, na.rm = T),2))
sd_pol <- paste(round(sd(pilot_prolific$politics_1, na.rm = T),2))

```

Total sample size was N = `r paste(n_prolific)` . The mean age of sample
was `r paste(m_age_prolific)`(`r paste(sd_age_prolific)`). Age range:
`r paste(min_age)` - `r paste(max_age)`

Political Ideology was scored on a 7-point Likert scale with 1 = Most
Conservative and 7 = Most Liberal. The mean political ideology was
`r paste(m_pol)`(`r paste(sd_pol)`), showing that this sample is skewing
slightly more left-leaning.



```{r agegraph, echo=FALSE, message=FALSE, warning=FALSE}

pilot_prolific %>% 
  ggplot() +
  geom_histogram(aes(age)) +
  theme_minimal()

```

```{r polgraph, echo=FALSE, message=FALSE, warning=FALSE}

pilot_prolific %>% 
  ggplot() +
  geom_histogram(aes(politics_1)) +
  scale_x_continuous(breaks = c(1:7)) +
  theme_minimal()

```

Gender and ethnoracial demographics are reported in the tables below.

```{r gender table, include=FALSE}
desc_table <-
pilot_prolific %>% 
     group_by(gender) %>% 
     summarise(n = length(id),
               `Age(mean)` = round(mean(age, na.rm = T),2),
              `Age(sd)` = ifelse(is.na(sd(age, na.rm=T)), print(NaN), print(round(sd(age, na.rm = T),2)))) 



```

::: row
::: {.col-xs-12 .col-md-6}
```{r printdesctable, echo=FALSE, message=FALSE, paged.print=FALSE}
 
     flextable(desc_table) %>% 
  autofit() 
     #%>% 
 # set_caption(caption = "Gender")

```

`r officer::run_columnbreak()`
:::

::: {.col-xs-12 .col-md-6}
```{r race, echo=FALSE}


pilot_prolific %>% 
     group_by(ethnicity) %>% 
     summarise(n = length(id)) %>% 
     flextable() %>% 
  autofit() #%>% 
 # set_caption(caption = "Ethnoracial")

```
:::
:::

<!---BLOCK_MULTICOL_STOP{widths: [4,2], space: 0.1, sep: false}--->

# Variables

```{r list of variables, echo=FALSE}
final_items <-
  items %>% 
  filter(Item_code != "AIMES_18" &
           Item_code != "AIMES_19" &
           Item_code != "AIMES_9" &
           Item_code != "AIMES_10" &
           Item_code != "AIMES_11")


final_items %>% 
  flextable() %>% 
  autofit()
  
```

# Assumption Checks

## Correlations between variables

Presented in order of suspected dimensions

```{r Description of Variables, echo=FALSE}
#arrange in order of predicted dimensions
col_order <- c("AIMES_4", "AIMES_1", "AIMES_2", "DISPO_29", "DISPO_21", "DISPO_22", "DISPO_34", 
               "DISPO_32", "DISPO_37", "DISPO_38", "DISPO_39", "DISPO_16", "DISPO_36",
               "AIMES_8", "AIMES_6", "AIMES_5", "AIMES_7",
               "AIMES_9", "AIMES_10", "AIMES_11",
               "AIMES_15", "AIMES_14", "DISPO_28", "DISPO_8", "DISPO_13", "DISPO_18", "DISPO_26","DISPO_33", "DISPO_19", "NEW_4", "DISPO_1", "DISPO_5", "DISPO_6", "DISPO_20", "NEW_5", "DISPO_7", "DISPO_23", 
               "DISPO_2", "DISPO_10", "DISPO_11", "DISPO_12", "DISPO_15", "NEW_6", "NEW_7", "NEW_8", "NEW_11", "NEW_12",
               "AIMES_17", "NEW_1", "NEW_9", "NEW_10", "NEW_2", "SPIRIT_10", "SPIRIT_12", "AIMES_18", "AIMES_19", "AIMES_20", "NEW_3")

factor_order_prolific <-
  pilot_prolific[, ..col_order]

factor_order_prolific <-
  factor_order_prolific %>% 
  select(-AIMES_18,
         -AIMES_19,
         -AIMES_9,
         -AIMES_10,
         -AIMES_11)


#correlation
big_corr_prolific <-
factor_order_prolific %>% 
  as.matrix() %>% 
  rcorr()

corrplot(big_corr_prolific$r, method = "shade", type = "upper", tl.cex = .35, tl.col = "black", number.cex = .35,  number.digits = 2, 
         p.mat = cor.mtest(factor_order_prolific)$p, sig.level = 0.01, insig = "blank")


```

## Determinant V1

Check on the whether the model will be overdetermined Should aim for a
determinant \> .00001 (Field et al., 2012)

```{r EFA pre-tests, echo=FALSE}

#find the determinant of our matrix - to see if our matrix is too intercorrelated
#it may be overdetermined
determined <- 
format.pval(det(big_corr_prolific$r), eps = .00001, scientific = F)



```

Our model may be overdetermined. Determinant `r paste(determined)`

With more variables included there is the danger for multi-collinearity.
First step is to remove items that have a correlation =\>0.8


```{r multi-collinear variables, echo=FALSE}
#Use the correlation matrix that I created earlier - big_corr$r

#correlations over 0.8
 round(big_corr_prolific$r, 2) %>% 
  as.data.frame() %>%
   rownames_to_column %>%
    gather(colname, value, -rowname) %>%
    filter(abs(value) >= 0.8 & abs(value) < 1) %>% 
  flextable() %>% 
  add_header_lines(values = "Correlations > .80") %>% 
  autofit()
 





```

```{r high multi-collinear variables, echo=FALSE, message=FALSE, warning=FALSE, include=FALSE}

high_cor_prolific <-
 factor_order_prolific %>% 
   select(AIMES_15,DISPO_28,AIMES_7, AIMES_6, AIMES_2) 

high_cor_prolific_cor <-
high_cor_prolific %>% 
  as.matrix() %>% 
  rcorr()




aimes2_15_dispo_28 <-
high_cor_prolific %>% 
  ggplot()+
  geom_smooth(aes(x = AIMES_15, y = AIMES_2), method = "lm", colour = "dark green") +
   geom_smooth(aes(x = DISPO_28, y = AIMES_2), method = "lm", colour = "dark red") +
  scale_x_continuous(breaks = c(1:7), labs(title = "Other Item (see legend)")) +
  scale_y_continuous(breaks = c(1:7), labs(title = "I feel right at home when I am in nature")) 

aimes_6_7 <-
  high_cor_prolific %>% 
  ggplot() +
  geom_smooth(aes(x = AIMES_6, y = AIMES_7), method = "lm")+
  scale_x_continuous(breaks = c(1:7), labs(title = "I think of myself as someone who is very concerned about taking care of nature")) +
  scale_y_continuous(breaks = c(1:7), labs(title = "Protecting nature is an important part of who I am"))

```


```{r corplot 1, echo=FALSE, warning=FALSE, message=FALSE}
aimes_6_7

```

```{r corplot 2, echo=FALSE, message=FALSE, warning=FALSE}
aimes2_15_dispo_28

```

Legend

- green = Being in nature allows me to do the things I like doing most 
- red = My favorite place is in nature

Removed items with high intercollinearity 

```{r Removing items colinearity, echo=FALSE}

filtered_factor_prolific <-
  factor_order_prolific %>% 
  select(-AIMES_15,
         -AIMES_7,
         -AIMES_2)

#new correlation matrix
new_cor_matrix_prolific <-
  filtered_factor_prolific %>% 
  as.matrix() %>% 
  rcorr()


#is it still overdetermined (accepted level of 0.00001)
new_det <-
  format.pval(det(new_cor_matrix_prolific$r), eps = .00001, scientific = F)#it may be overdetermined



```

Still may be overdetermined... Determinant = `r paste(new_det)`

Look at other items that might be a problem...

## Shared Variance

Ensuring there is shared variance between items (Bartlett's test of
sphericity)

```{r bartletts test, echo=FALSE, warning=FALSE, tidy=TRUE}

bartlet <- cortest.bartlett(filtered_factor_prolific) 

bartlet_p <- format.pval(bartlet$p.value, eps = 0.001)

```

Overall, our data is suitable for factor analysis (p value \<.001 are
adequate) $\chi^2$=
`r paste(round(bartlet$chisq,2))`(`r paste(bartlet$df)`) *p* =
`r paste(bartlet_p)`

## Proportion of Variance

(KMO test) Measures the amount of variance in items

```{r KMO test, echo=FALSE, tidy=TRUE}
kmo <- KMO(r=cor(filtered_factor_prolific))

new_cols <- c("AIMES_4", "AIMES_1", "DISPO_29", "DISPO_21", "DISPO_22", "DISPO_34", 
               "DISPO_32", "DISPO_37", "DISPO_38", "DISPO_39", "DISPO_16", "DISPO_36",
               "AIMES_8", "AIMES_6", "AIMES_5", 
                      "AIMES_14", "DISPO_28", "DISPO_8", "DISPO_13", "DISPO_18", "DISPO_26","DISPO_33", "DISPO_19", "NEW_4", "DISPO_1", "DISPO_5", "DISPO_6", "DISPO_20", "NEW_5", "DISPO_7", "DISPO_23", 
               "DISPO_2", "DISPO_10", "DISPO_11", "DISPO_12", "DISPO_15", "NEW_6", "NEW_7", "NEW_8", "NEW_11", "NEW_12",
               "AIMES_17", "NEW_1", "NEW_9", "NEW_10", "NEW_2", "SPIRIT_10", "SPIRIT_12",  "AIMES_20", "NEW_3")



kmo_items <-
as.matrix(kmo$MSAi) %>% 
  round(2) %>% 
  as.data.frame() %>% 
  add_column(new_cols, .before = "V1") 

colnames(kmo_items) <- c("Item", "KMO")




```

Overall, our data is suitable for factor analysis (overall MSA \> 0.8
are adequate). Data MSA = `r paste(kmo$MSA)`

There are a couple of items that are of concern:

```{r kmo concern, echo=FALSE}
kmo_items %>% 
    filter(KMO<.90) %>% 
  flextable() %>% 
  autofit()
```

-   DISPO_32 (The noise of crickets gets on my nerves [reversed])
-   DISPO_38 (I have mourned (or could imagine mourning) the loss of a
    pet)
-   DISPO_36 (Pets are part of the family)




## Ceiling and Floor Items

```{r box1, echo=FALSE}
boxplot(factor_order_prolific[,c(1:7)],
        las = 2)
```

Dispo_34 might have a ceiling effect going on (Listening to the sounds
of nature makes me relax)

```{r box2, echo=FALSE}
boxplot(factor_order_prolific[,c(8:14)],
        las = 2)
```

Celiing effects with 
- Dispo_38 (I have mourned (or could imagine mourning) the loss of a pet) 
- Dispo_39 (It makes me upset to see an animal that was hit by a car) 
- Dispo_36 (Pets are part of the family)

```{r box3, echo=FALSE}
boxplot(factor_order_prolific[,c(15:21)],
        las = 2)
```

```{r box4, echo=FALSE}
boxplot(factor_order_prolific[,c(22:28)],
        las = 2)
```

```{r box5, echo=FALSE}
boxplot(factor_order_prolific[,c(29:35)],
        las = 2)
```

```{r box6, echo=FALSE}
boxplot(factor_order_prolific[,c(36:42)],
        las = 2)
```

```{r box7, echo=FALSE}
boxplot(factor_order_prolific[,c(43:48)],
        las = 2)
```

New_9 has a floor effect (I regularly engage in a ritual practice that
involves nature (e.g., full moon or solstice rituals))

```{r box8, echo=FALSE}
boxplot(factor_order_prolific[,c(49:53)],
        las = 2)
```


## Skewedness

We can also look at the distribution of variables to remove any items
that have a high skewedness Presented in order of suspected dimensions

```{r distribution, echo=FALSE, paged.print=TRUE}
#plot of distribution
plot_histogram(factor_order_prolific)




```

Variables with non-normal distribution (after eyeballing the above
graphs)

-   DISPO_38
    -   I have mourned (or could imagine mourning) the loss of a pet
-   DISPO_39
    -   It makes me upset to see an animal that was hit by a car
-   DISPO_36
    -   Pets are part of the family
-   DISPO_1
    -   When encountering an animal I mimic their behaviour
-   DISPO_5
    -   When I am outside on grass, sand, or soil, I often take off my
        shoes to feel the ground on my feet
-   DISPO_6
    -   I talk to plants
-   DISPO_7
    -   I am careful to not step on snails
-   NEW_9
    -   I regularly engage in a ritual practice that involves nature
        (e.g., full moon or solstice rituals)


Removing items of concern...

```{r Removing items with high skew, echo=FALSE}

filtered_factor_prolific <-
  factor_order_prolific %>% 
  select(-NEW_9,
         -DISPO_38,
         -DISPO_39,
         -DISPO_6,
         -DISPO_36)
    
#new correlation matrix
new_cor_matrix_prolific <-
  filtered_factor_prolific %>% 
  as.matrix() %>% 
  rcorr()


#is it still overdetermined (accepted level of 0.00001)
new_det2 <-
  format.pval(det(new_cor_matrix_prolific$r), eps = .00001, scientific = F)#it may be overdetermined



```

Still may be overdetermined... Determinant = `r paste(new_det2)`
But we will look at the EFA anyway



# Exploratory Factor Analysis

How many factors can we extract

```{r EFA, include=FALSE}

eigens_prolific <-
  eigen(cor(filtered_factor_prolific))

# eigens$values
# uncomment to view the individual eigenvalues

scree(factor_order_prolific, pc=FALSE)

parallel <- 
fa.parallel(factor_order_prolific, fa = "fa")



```

```{r n factors, echo=FALSE}
scree(factor_order_prolific, pc=FALSE)
plot(parallel,)

```


Scree plot suggest \~3-4 factors Parallel factor suggests `r paste(parallel$nfact)` factors

# 6 Factors

```{r 6 factors efa, include=FALSE}
#function to build a pretty table
fa_table <- function(x, cut) {
  loadings <- fa.sort(x)$loadings %>% round(3)
  loadings[loadings < cut] <- ""
  loadings %>%
    unclass() %>%
    as.data.frame() %>%
    rownames_to_column("item") %>%
    mutate(across(where(is.numeric), round, 3))
}


fit_6_prolific <- 
  fa(filtered_factor_prolific, 6, rotate="promax", fm= "pa") %>% 
  fa.sort

#correlation matrix between factors
phi <- fit_6_prolific$Phi

#calculating the omega (better reliabiilty than cronbach alpha)
omega_6 <- 
  omega(fit_6_prolific$Phi, 6)


omega_row <- list(item = "Omega",
                  PA1 = round(omega_6$omega.group$total[2], 3), # for factor 1
                  PA2 = round(omega_6$omega.group$total[3], 3), # for factor 2
                  PA3 = round(omega_6$omega.group$total[4], 3), # for factor 3
                  PA4 = round(omega_6$omega.group$total[5], 3), # for factor 4
                  PA5 = round(omega_6$omega.group$total[6], 3), # for factor 5
                  PA6 = omega_6$omega.group$total[7] # for factor 6
                                )

fa_6_table <- 
  fa_table(fit_6_prolific, cut = .0) %>% 
  flextable() %>% 
  add_body(top = F, values = omega_row)


```


```{r 6 factor loading table, echo=FALSE}
fa_6_table %>% 
  autofit() %>% 
  color(color = "grey", 
        i = ~ PA1 <.4, 2) %>% 
  color(color = "grey", 
        i = ~ PA2 <.4, 3) %>% 
  color(color = "grey", 
        i = ~ PA3 <.4, 4) %>% 
  color(color = "grey", 
        i = ~ PA6 <.4, 5) %>% 
  color(color = "grey", 
        i = ~ PA4 <.4, 6) %>% 
  color(color = "grey", 
        i = ~ PA5 <.4, 7)


#PA2 < .4 | PA3 < .4 | PA4 < .4 | PA5 < .4 | PA6 < .4)



```



# 5 factors

```{r 5 factors EFA, echo=FALSE}
#principal axis (for non-normal data)
fit_5_prolific <- 
  fa(filtered_factor_prolific, 5, rotate="promax", fm= "pa") %>% 
  fa.sort

phi <- fit_5_prolific$Phi

print(fit_5_prolific)
print(fit_5_prolific$loadings, cut = .4) 

fa.diagram(fit_5_prolific, Phi = phi, cex = 1.5, e.size = 0.05, rsize = 0.5)


```

# 4 factors

```{r 4 factors EFA , echo=FALSE}

#principal axis (for non-normal data)
fit_4_prolific <- 
  fa(filtered_factor_prolific, 4, rotate="promax", fm= "pa") %>% 
  fa.sort

phi <- fit_4_prolific$Phi

print(fit_4_prolific)
print(fit_4_prolific$loadings, cut = .4) 

fa.diagram(fit_4_prolific, Phi = phi, cex = 1.5, e.size = 0.05, rsize = 0.5)


```

Remove items that cross load and fall under the cut-off of .40

```{r 4 factors simple EFA , echo=FALSE}
filtered_factor_4_prolific2 <-
  filtered_factor_prolific %>% 
  select(-AIMES_4, 
        -AIMES_5,
        -NEW_5,
        -DISPO_5,
        -DISPO_19,
        -DISPO_13,
        -DISPO_26,
        -DISPO_32,
        -NEW_8,
        -DISPO_20,
        -DISPO_23,
        -NEW_6,
        -NEW_4)

#principal axis (for non-normal data)
fit_4_prolific2 <- 
  fa(filtered_factor_4_prolific2, 4, rotate="promax", fm= "pa") %>% 
  fa.sort

phi <- fit_4_prolific2$Phi

print(fit_4_prolific2)
print(fit_4_prolific2$loadings, cut = .4) 

fa.diagram(fit_4_prolific2, Phi = phi, cex = 1.5, e.size = 0.05, rsize = 0.5)


```

# Final Assumptions

```{r Assumptions 2, echo=FALSE}
KMO(r=cor(filtered_factor_4_prolific2))

cortest.bartlett(filtered_factor_4_prolific2) 

big_corr_prolific_post <-
filtered_factor_4_prolific2 %>% 
  as.matrix() %>% 
  rcorr()

det(big_corr_prolific_post$r)


eigens_prolific_post <-
  eigen(big_corr_prolific_post$r)

# eigens$values
# uncomment to view the individual eigenvalues

scree(big_corr_prolific_post$r, factors = TRUE, pc=FALSE)

fa.parallel(big_corr_prolific_post$r, fa = "fa", n.obs = 575)


```
